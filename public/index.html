<!DOCTYPE html>
    <head>
        <link rel="stylesheet" href="style.css">
        <script src="/socket.io/socket.io.js"></script>
    </head>
    <body>
        <p id="points">Points:</p>
        <canvas id="canvas" width="10" height="10"></canvas></br>
        <script type="module">
            import updateCanvas from './update_canvas.js'
            import keyboardListener from './keyboard_listener.js'
            import game from './game.js'

            const socket = io()
            const gamevar = game()
            const keyboardListenerVar = keyboardListener()

            socket.on('connect', function(){
                const playerId = socket.id
                const player = gamevar.state.players[playerId]

                console.log('> Connected with Id: ' + playerId)

                updateCanvas(canvas, gamevar, requestAnimationFrame, playerId)
            })
            socket.on('ready', function(state){
                const playerId = socket.id
                
                console.log('> Server Ready!')
                gamevar.setState(state)

                keyboardListenerVar.registerPlayer(playerId)
                keyboardListenerVar.subscribe(gamevar.movePlayer)
                
                keyboardListenerVar.subscribe(function(command){
                    socket.emit('move-player', command)
                })
            })

            socket.on('add-player', function(command){
                const playerId = socket.id

                console.log('> Receiving command: ' + command.type)
                gamevar.addPlayer(command)

                const player = gamevar.state.players[playerId]
                document.getElementById('points').innerHTML = playerId + ': ' + player.points
            })
            socket.on('remove-player', function(command){
                console.log('> Receiving command: ' + command.type)
                gamevar.removePlayer(command)
            })
            socket.on('add-fruit', function(command){
                console.log('> Receiving command: ' + command.type)
                gamevar.addFruit(command)
            })
            socket.on('remove-fruit', function(command){
                const playerId = socket.id
                const player = gamevar.state.players[playerId]
                console.log('> Receiving command: ' + command.type)
                
                gamevar.removeFruit(command)
                document.getElementById('points').innerHTML = playerId + ': '+ player.points  
            })
            socket.on('move-player', function(command){
                const playerId = socket.id

                console.log('> Receiving command: ' + command.type)

                if (playerId !== command.playerId){
                    gamevar.movePlayer(command)
                }
            })
            socket.on('disconnect', function(){
                    keyboardListenerVar.unsubscribeAll()
                })
        </script>
    </body>
</html>